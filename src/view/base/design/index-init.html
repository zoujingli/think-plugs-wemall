<script class="layui-hide" type="text/html" id="LayoutSettingFormTemplate">
    <div>
        <div v-for="(x,$index) in items" :key="Math.random()">
            <label v-if="x.type==='页面间距'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '页面间距'}}</span>
                <input type="range" min="0" step="0.01" v-model="mstyle.vMarginTop" max="10">
                <span class="layui-form-label text-left flex-1" style="width:auto">{{mstyle.vMarginTop}} vw</span>
            </label>
            <label v-if="x.type==='上下内距'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '上下内距'}}</span>
                <input type="range" min="0" step="0.01" v-model="mstyle.vPaddingTopBottom" max="10">
                <span class="layui-form-label text-left flex-1" style="width:auto">{{mstyle.vPaddingTopBottom}} vw</span>
            </label>
            <label v-if="x.type==='左右内距'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '左右内距'}}</span>
                <input type="range" min="0" step="0.01" v-model="mstyle.vPaddingLeftRight" max="10">
                <span class="layui-form-label text-left flex-1" style="width:auto">{{mstyle.vPaddingLeftRight}} vw</span>
            </label>
            <label v-if="x.type==='上下间距'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '上下间距'}}</span>
                <input type="range" min="0" step="0.01" v-model="mstyle.vMarginTopBottom" max="10">
                <span class="layui-form-label text-left flex-1" style="width:auto">{{mstyle.vMarginTopBottom}} vw</span>
            </label>
            <label v-if="x.type==='左右间距'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '左右间距'}}</span>
                <input type="range" min="0" step="0.01" v-model="mstyle.vMarginLeftRight" max="10">
                <span class="layui-form-label text-left flex-1" style="width:auto">{{mstyle.vMarginLeftRight}} vw</span>
            </label>
            <div v-if="x.type==='边框位置'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '边框位置'}}</span>
                <div class="flex-1">
                    <div class="layui-btn-group">
                        {{mstyle.vBorderType || ''}}
                        <a :class="(mstyle.vBorderType||'').indexOf('t')>-1?'layui-btn-normal':'layui-btn-primary'" @click="char('vBorderType','t')" class="layui-btn">上</a>
                        <a :class="(mstyle.vBorderType||'').indexOf('r')>-1?'layui-btn-normal':'layui-btn-primary'" @click="char('vBorderType','r')" class="layui-btn">右</a>
                        <a :class="(mstyle.vBorderType||'').indexOf('b')>-1?'layui-btn-normal':'layui-btn-primary'" @click="char('vBorderType','b')" class="layui-btn">下</a>
                        <a :class="(mstyle.vBorderType||'').indexOf('l')>-1?'layui-btn-normal':'layui-btn-primary'" @click="char('vBorderType','l')" class="layui-btn">左</a>
                    </div>
                </div>
            </div>
            <div v-if="x.type==='边框样式'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '边框样式'}}</span>
                <div class="flex-1">
                    <div class="layui-btn-group">
                        <a :class="mstyle.borderStyle==='solid'?'layui-btn-normal':'layui-btn-primary'" @click="$set(mstyle,'borderStyle','solid')" class="layui-btn">实 线</a>
                        <a :class="mstyle.borderStyle==='dashed'?'layui-btn-normal':'layui-btn-primary'" @click="$set(mstyle,'borderStyle','dashed')" class="layui-btn">虚 线</a>
                        <a :class="mstyle.borderStyle==='dotted'?'layui-btn-normal':'layui-btn-primary'" @click="$set(mstyle,'borderStyle','dotted')" class="layui-btn">点状线</a>
                    </div>
                </div>
            </div>
            <div v-if="x.type==='边框颜色'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '边框颜色'}}</span>
                <div class="flex-1">
                    <color-picker :mstyle="mstyle" mfield="borderColor"></color-picker>
                </div>
            </div>
            <label v-if="x.type==='边框宽度'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '边框宽度'}}</span>
                <input type="range" min="0" step="0.01" v-model="mstyle.vBorderWidth" max="10">
                <span class="layui-form-label text-left flex-1" style="width:auto">{{mstyle.vBorderWidth}} vw</span>
            </label>
            <label v-if="x.type==='边框圆角'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '边框圆角'}}</span>
                <input type="range" step="0.01" min="0" max="50" v-model="mstyle.vBorderRadius">
                <span class="layui-form-label text-left flex-1">{{mstyle.vBorderRadius}} vw</span>
            </label>
            <label v-if="x.type==='容器宽度'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '容器宽度'}}</span>
                <input type="range" min="0.01" step="0.01" v-model="mstyle.vWidth" max="100">
                <span class="layui-form-label text-left flex-1">{{mstyle.vWidth}} %</span>
            </label>
            <label v-if="x.type==='容器宽度2'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '容器宽度'}}</span>
                <input type="range" min="0.01" step="0.01" v-model="mstyle.vWidth2" max="100">
                <span class="layui-form-label text-left flex-1">{{mstyle.vWidth2}} vw</span>
            </label>
            <label v-if="x.type==='容器高度'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '容器高度'}}</span>
                <input type="range" min="0.01" step="0.01" v-model="mstyle.vHeight" max="100">
                <span class="layui-form-label text-left flex-1" style="width:auto">{{mstyle.vHeight}} vw</span>
            </label>
            <div v-if="x.type==='文字位置'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '文字位置'}}</span>
                <div class="flex-1">
                    <div class="layui-btn-group">
                        <a :class="mstyle.textAlign==='left'?'layui-btn-normal':'layui-btn-primary'" @click="$set(mstyle,'textAlign','left')" class="layui-btn">居 左</a>
                        <a :class="mstyle.textAlign==='center'?'layui-btn-normal':'layui-btn-primary'" @click="$set(mstyle,'textAlign','center')" class="layui-btn">居 中</a>
                        <a :class="mstyle.textAlign==='right'?'layui-btn-normal':'layui-btn-primary'" @click="$set(mstyle,'textAlign','right')" class="layui-btn">居 右</a>
                    </div>
                </div>
            </div>
            <label v-if="x.type==='文字粗细'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '文字粗细'}}</span>
                <input type="range" min="100" step="100" v-model="mstyle.fontWeight" max="900">
                <span class="layui-form-label text-left flex-1" style="width:auto">{{mstyle.fontWeight}}</span>
            </label>
            <label v-if="x.type==='文字行高'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '文字行高'}}</span>
                <input type="range" min="0" step="0.01" v-model="mstyle.vLineHeight" max="50">
                <span class="layui-form-label text-left flex-1" style="width:auto">{{mstyle.vLineHeight}} vw</span>
            </label>
            <label v-if="x.type==='文字大小'" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '文字大小'}}</span>
                <input type="range" min="0.05" step="0.01" v-model="mstyle.vFontSize" max="10">
                <span class="layui-form-label text-left flex-1" style="width:auto">{{mstyle.vFontSize}} vw</span>
            </label>
            <div v-if="x.type==='文字颜色'" class="layui-form-item flex">
                <span class="design-form-label">{{x.name || '文字颜色'}}</span>
                <color-picker :mstyle="mstyle" mfield="color"></color-picker>
            </div>
            <div v-if="x.type==='背景颜色'" class="layui-form-item flex">
                <span class="design-form-label">{{x.name || '背景颜色'}}</span>
                <color-picker :mstyle="mstyle" mfield="backgroundColor"></color-picker>
            </div>
            <div v-if="x.type==='背景图片'" class="layui-form-item flex">
                <span class="design-form-label">{{x.name || '背景图片'}}</span>
                <div class="flex-1">
                    <upload-image :mstyle="mstyle" :showinput="false" mfield="vBackgroundImage"></upload-image>
                </div>
            </div>
            <div v-if="x.type==='背景样式' && !!mstyle.vBackgroundImage" class="layui-form-item flex flex-align-center">
                <span class="design-form-label">{{x.name || '背景样式'}}</span>
                <div class="flex-1">
                    <label class="think-radio" v-for="(xx,$ii) in ['重复平铺','横向平铺','垂直平铺','全屏拉伸','居中裁剪']">
                        <input type="radio" :name="x.guid" :value="$ii" v-model="mstyle.vBackgroundType" lay-ignore> {{xx}}
                    </label>
                </div>
            </div>
        </div>
    </div>
</script>

<script>
    function initVueComponents(Vue) {

        Vue.directive('range', (el) => {
            let value = el.value;
            let max = el.max || null, min = el.min || null;
            if (max !== null) value = Math.min(value, max);
            if (min !== null) value = Math.max(value, min);
            el.value = value;
            setTimeout(() => el.value = value, 50)
        });

        Vue.mixin({
                methods: {
                    copy: (x) => JSON.parse(JSON.stringify(x)),
                    guid: pre => Math.random().toString().replace('0.', (pre || '')).substring(-16),
                    showText: txt => txt.replace(/\n/g, '<br>'),
                    showBgimg: src => ({backgroundImage: "url('" + src + "')"}),
                    showColor: clr => ({color: clr}),
                    showError: tips => ($.msg.notify('操作异常提示：', tips, 2000, {width: '350px', type: 'error'}), this),
                    showStyle: function (data, extra, allow) {
                        let width = 400, style = Object.assign({}, JSON.parse(JSON.stringify(data)), extra || {});
                        let allows = allow ? ',' + allow + ',' : false;
                        let borders = {t: 'borderTopWidth', l: 'borderLeftWidth', r: 'borderRightWidth', b: 'borderBottomWidth'};
                        for (let key in style) {
                            if (allows && allows.indexOf(key) === -1) {
                                delete style[key];
                                continue;
                            }
                            let value = style[key];
                            let realpx = (isNaN(Number(value)) ? 0 : value * width / 100) + 'px';
                            if (/^[_v]/.test(key)) delete style[key];
                            if (key === 'vWidth2') {
                                style.width = realpx;
                                style.maxWidth = '100%';
                            }
                            if (key === 'vWidth') style.width = value + '%';
                            if (key === 'vHeight') style.height = realpx;
                            if (key === 'vFontSize') style.fontSize = realpx;
                            if (key === 'vLineHeight') style.lineHeight = realpx;
                            if (key === 'vMarginTop') style.marginTop = realpx;
                            if (key === 'vBorderRadius') {
                                style.overflow = 'hidden';
                                style.borderRadius = realpx;
                            }
                            for (let i in borders) {
                                if (key === 'vBorderType' && value) {
                                    value.indexOf(i) < 0 && (style[borders[i]] = 0);
                                }
                                if (key === 'vBorderWidth') {
                                    if (typeof style[borders[i]] === 'undefined') {
                                        style[borders[i]] = realpx;
                                        style.boxSizing = 'border-box';
                                    }
                                }
                            }
                            if (key === 'vBackgroundImage') style.backgroundImage = "url('" + value + "')";
                            if (key === 'vPaddingTopBottom') {
                                style.boxSizing = 'border-box';
                                style.paddingTop = style.paddingBottom = realpx;
                            }
                            if (key === 'vPaddingLeftRight') {
                                style.boxSizing = 'border-box';
                                style.paddingLeft = style.paddingRight = realpx;
                            }
                            if (key === 'vMarginTopBottom') {
                                style.boxSizing = 'border-box';
                                style.marginTop = style.marginBottom = realpx;
                            }
                            if (key === 'vMarginLeftRight') {
                                style.boxSizing = 'border-box';
                                style.marginLeft = style.marginRight = realpx;
                            }
                            // '重复平铺','重复平铺','垂直平铺','全屏拉伸','居中裁减'
                            if (key === 'vBackgroundType') {
                                if (value === 0) {
                                    style.backgroundSize = 'auto';
                                    style.backgroundRepeat = 'repeat'
                                } else if (value === 1) {
                                    style.backgroundSize = 'contain';
                                    style.backgroundRepeat = 'repeat no-repeat'
                                } else if (value === 2) {
                                    style.backgroundSize = 'contain';
                                    style.backgroundRepeat = 'no-repeat repeat'
                                } else if (value === 3) {
                                    style.backgroundSize = '100% 100%';
                                    style.backgroundRepeat = 'no-repeat';
                                } else if (value === 4) {
                                    style.backgroundSize = 'cover'
                                    style.backgroundRepeat = 'no-repeat'
                                    style.backgroundPosition = 'center center';
                                }
                            }
                        }
                        return style;
                    }
                }
            }
        );

        Vue.component('ColorPicker', {
            data: () => ({eid: '', value: ''}),
            props: {mstyle: {type: Object, required: true}, mfield: {type: String, required: true}},
            template: '<div class="relative">' +
                '   <label class="layui-input-inline" style="width:230px">' +
                '       <input :value="value" placeholder="请选择颜色" class="layui-input layui-bg-gray text-center" readonly>' +
                '   </label>' +
                '   <div class="layui-inline absolute"><div :id="eid" class="margin-0">eid</div></div>' +
                '</div>',
            created: function () {
                let key = '_' + this.mfield.replace(/([A-Z])/g, '_$1').toLowerCase();
                this.eid = this.mstyle[key] || Math.random().toString().replace('0.', 'colorpicker-');
                this.value = this.mstyle[this.mfield] || '';
            },
            mounted: function () {
                let done = color => this.$set(this.mstyle, this.mfield, this.value = color) && this.$forceUpdate();
                this.$nextTick(() => layui.colorpicker.render({elem: '#' + this.eid, color: this.value, predefine: true, alpha: true, format: 'rgb', done: done, change: done}));
            }
        });

        Vue.component('UploadImage', {
            data: () => ({eid: '', value: '', mclass: 'layui-show'}),
            props: {mstyle: {type: Object, required: true}, mfield: {type: String, required: true}, showinput: {type: Boolean, default: true}},
            template: '<div class="relative">' +
                '   <input class="layui-input layui-bg-gray" :class="mclass" v-model="value" readonly :id="eid" placeholder="请上传图片">' +
                '   <a class="input-right-icon" :class="mclass" data-type="jpg,png,gif" :data-upbtn="eid"><i class="layui-icon layui-icon-upload"></i></a>' +
                '</div>',
            created: function () {
                if (this.showinput === false) this.mclass = 'layui-hide';
                let key = '_' + this.mfield.replace(/([A-Z])/g, '_$1').toLowerCase();
                this.eid = this.mstyle[key] || Math.random().toString().replace('0.', 'uploadimage-');
            },
            mounted: function () {
                this.value = this.mstyle[this.mfield] || '';
                let done = e => this.$set(this.mstyle, this.mfield, e.target.value);
                this.$nextTick(() => {
                    let $ele = $('#' + this.eid).uploadOneImage().on('change', done);
                    $('[data-upbtn=' + this.eid + ']').uploadFile(src => $ele.val(src).trigger('change'));
                });
            }
        });

        Vue.component('LayoutSetting', {
            data: () => ({items: []}),
            props: {mstyle: Object, mtypes: {type: String, default: '页面间距,边框圆角,容器宽度,容器高度'}},
            template: $('#LayoutSettingFormTemplate').html(),
            created: function () {
                this.mtypes.split(',').forEach(v => {
                    if (!v && typeof v !== 'string') return;
                    let attr = v.split('#');
                    this.items.push({type: attr[0], name: attr[1] || '', guid: this.guid('_')});
                });
            }, methods: {
                /**
                 * @param {String} field
                 * @param {String} char
                 */
                char: function (field, char) {
                    let value = this.mstyle[field] || '';
                    this.$set(this.mstyle, field, value.indexOf(char) >= 0 ? value.replace(new RegExp(char, 'i'), '') : (value + char));
                    //this.mstyle[field] = value.indexOf(char) >= 0 ? value.replace(new RegExp(char, 'i'), '') : (value + char);
                }
            }
        });

        return Vue;
    }
</script>